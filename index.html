<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GDE - Geo Guessing Game</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
    
    <!-- Panorama API Proxy (must load before Panorama library) -->
    <script src="panorama-proxy.js"></script>
    
    <!-- Panorama JS -->
    <script type="text/javascript" src="https://api.mapy.cz/js/panorama/v1/panorama.js"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div id="app">
        <!-- Start Screen -->
        <div id="startScreen">
            <div class="start-container" style="position: relative;">
                <h1 data-i18n="app.title">GDE SU?!</h1>
                <p class="subtitle" data-i18n="app.subtitle">Geo Guessing Game</p>
                
                <!-- Language Selector -->
                <div style="text-align: center; margin-bottom: 20px;">
                    <label for="languageSelect" style="margin-right: 10px; font-weight: 600;" data-i18n="language">Language:</label>
                    <select id="languageSelect" style="padding: 8px 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px; cursor: pointer; background: white;">
                        <option value="en">English</option>
                        <option value="cs">ƒåe≈°tina</option>
                    </select>
                </div>
                
                <!-- Multiplayer Button -->
                <div style="text-align: center; margin-bottom: 15px;">
                    <button id="switchToMultiplayerBtn" class="btn btn-secondary" style="padding: 10px 20px;">
                        <span data-i18n="btn.multiplayer">üë• Multiplayer Mode</span>
                    </button>
                </div>
                
                <div class="start-section">
                    <h2 data-i18n="region.select">Select Region</h2>
                    <div class="region-grid">
                        <button class="region-btn" data-region="czechia">
                            <span class="region-icon">üá®üáø</span>
                            <span class="region-name" data-i18n="region.czechia">Czech Republic</span>
                        </button>
                        <button class="region-btn" id="searchLocationBtn">
                            <span class="region-icon">üîé</span>
                            <span class="region-name" data-i18n="region.search_location">Search Location</span>
                            <span class="clear-search-btn" id="clearSearchBtn" title="Clear search" style="display: none;">√ó</span>
                        </button>
                        <button class="region-btn" id="citiesBtn">
                            <span class="region-icon">üèôÔ∏è</span>
                            <span class="region-name" data-i18n="region.cities">Cities</span>
                            <select id="citySelect" class="region-select" onclick="event.stopPropagation();">
                                <option value="" data-i18n="region.select_city">Select a city...</option>
                                <option value="praha" data-i18n="region.prague">Prague</option>
                                <option value="brno" data-i18n="region.brno">Brno</option>
                            </select>
                        </button>
                        <button class="region-btn" id="historicalRegionsBtn">
                            <span class="region-icon">üè∞</span>
                            <span class="region-name" data-i18n="region.historical_regions">Historical Regions</span>
                            <select id="historicalRegionSelect" class="region-select" onclick="event.stopPropagation();">
                                <option value="" data-i18n="region.select_region">Select a region...</option>
                                <option value="bohemia" data-i18n="region.bohemia">Bohemia</option>
                                <option value="moravia" data-i18n="region.moravia">Moravia</option>
                                <option value="silesia" data-i18n="region.silesia">Silesia</option>
                                <option value="moravia_silesia" data-i18n="region.moravia_silesia">Moravia and Silesia</option>
                            </select>
                        </button>
                        <button class="region-btn" id="drawRegionBtn">
                            <span class="region-icon">‚úèÔ∏è</span>
                            <span class="region-name" data-i18n="region.draw">Draw Region</span>
                        </button>
                    </div>
                </div>
                
                <div class="start-section">
                    <h2 data-i18n="gamemode.select">Select Game Mode</h2>
                    <div class="mode-grid">
                        <button class="mode-btn" data-mode="explorer">
                            <span class="mode-icon">üö∂</span>
                            <span class="mode-name" data-i18n="gamemode.explorer">Explorer Mode</span>
                            <span class="mode-desc" data-i18n="gamemode.explorer.desc">Move around and explore the panorama</span>
                        </button>
                        <button class="mode-btn" data-mode="static">
                            <span class="mode-icon">üì∏</span>
                            <span class="mode-name" data-i18n="gamemode.static">Static Mode</span>
                            <span class="mode-desc" data-i18n="gamemode.static.desc">Fixed view, no movement allowed</span>
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button id="difficultyPrefsBtn" class="btn btn-secondary"><span data-i18n="btn.settings">‚öôÔ∏è Game Settings</span></button>
                    <button id="startGameBtn" class="btn btn-success" disabled data-i18n="btn.start">Start Game</button>
                </div>
                
                <div style="text-align: center; margin-top: 20px; opacity: 0.5; font-size: 0.85em;">
                    <span id="versionInfo">Loading version...</span>
                </div>
            </div>
        </div>

        <!-- Header -->
        <header style="display: none;">
            <h1 class="game-title" data-i18n="app.title">üåç GDE SU?!</h1>
            <div class="score-container">
                <div class="score-item" id="timerDisplay" style="display: none;">
                    <span class="label" data-i18n="header.time">‚è±Ô∏è Time:</span>
                    <span id="timerValue">2:00</span>
                </div>
                <div class="score-item">
                    <span class="label" data-i18n="header.round">Round:</span>
                    <span id="currentRound">1</span>/<span id="totalRounds">5</span>
                </div>
                <div class="score-item">
                    <span class="label" data-i18n="header.score">Total Score:</span>
                    <span id="totalScore">0</span>
                </div>
                <button id="finishGame" class="btn btn-secondary" style="display: none; margin-left: 15px;" data-i18n="btn.finish">üèÅ Finish Game</button>
            </div>
        </header>

        <!-- Game Container -->
        <div id="gameContainer" style="display: none;">
            <!-- Fullscreen Panorama View -->
            <div id="panoramaSection">
                <div id="panoramaContainer"></div>
                <button id="resetLocationBtn" class="reset-location-btn" style="display: none;" title="Reset to Original Location" data-i18n="btn.reset" data-i18n-title="btn.reset.title">
                    üîÑ Reset Location
                </button>
            </div>

            <!-- Floating Map Overlay -->
            <div id="mapOverlay" class="collapsed">
                <div id="mapHeader">
                    <div class="map-title">
                        <span data-i18n="map.title">üó∫Ô∏è Make your guess</span>
                    </div>
                    <div class="map-controls">
                        <select id="mapLayerSelect" title="Map Layer">
                            <option value="basic" data-i18n="map.layer.basic">Basic</option>
                            <option value="outdoor" data-i18n="map.layer.outdoor">Outdoor</option>
                            <option value="winter" data-i18n="map.layer.winter">Winter</option>
                            <option value="aerial" data-i18n="map.layer.aerial">Aerial</option>
                        </select>
                        <button id="toggleMapSize" class="icon-btn" title="Expand/Collapse">
                            <span id="toggleIcon">‚õ∂</span>
                        </button>
                    </div>
                </div>
                <div id="mapContainer"></div>
                <div class="map-footer">
                    <button id="submitGuess" class="btn btn-primary btn-compact" disabled data-i18n="btn.submit">Submit Guess</button>
                </div>
            </div>
        </div>

        <!-- Result Modal -->
        <div id="resultModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 id="resultTitle" data-i18n="result.title">Round Result</h2>
                <div id="resultDetails">
                    <p><strong data-i18n="result.distance">Distance:</strong> <span id="resultDistance"></span></p>
                    <p><strong data-i18n="result.score">Score:</strong> <span id="resultScore"></span></p>
                </div>
                <div id="resultMap"></div>
                <div id="multiplayerCountdown" style="display: none; text-align: center; margin-top: 15px; font-size: 16px; color: #667eea; font-weight: 600;">
                    Next round starts in <span id="countdownTimer">5</span> seconds...
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button id="minimizeResult" class="btn btn-secondary" data-i18n="btn.minimize">Minimize</button>
                    <button id="nextRound" class="btn btn-primary" style="display: none;" data-i18n="btn.next">Next Round</button>
                </div>
            </div>
        </div>

        <!-- Restore Result Button (shown when minimized) -->
        <div id="minimizedControls" class="minimized-controls">
            <button id="restoreResult" class="restore-btn" data-i18n="btn.restore">
                üìä Show Results
            </button>
            <button id="quickNextRound" class="restore-btn restore-btn-next" data-i18n="btn.next">
                ‚ñ∂Ô∏è Next Round
            </button>
        </div>

        <!-- Multiplayer Winner Modal -->
        <div id="winnerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 data-i18n="final.title">üèÜ Game Finished!</h2>
                <div id="winnerAnnouncement" style="text-align: center; margin: 20px 0; font-size: 24px; font-weight: bold; color: #667eea;">
                </div>
                <div id="finalScoreboard"></div>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button id="backToMenuBtn" class="btn btn-primary" data-i18n="btn.backmenu">Back to Menu</button>
                </div>
            </div>
        </div>

        <!-- Game Settings Modal -->
        <div id="difficultyModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 data-i18n="settings.title">‚öôÔ∏è Game Settings</h2>
                <p class="modal-subtitle" data-i18n="settings.subtitle">Customize your game settings</p>
                
                <div class="preferences-list">
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title" data-i18n="settings.maplayers">Switch Map Layers</div>
                            <div class="preference-desc" data-i18n="settings.maplayers.desc">Allow changing map style in minimap</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pref-mapLayers" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title" data-i18n="settings.showregion">Show Play Region</div>
                            <div class="preference-desc" data-i18n="settings.showregion.desc">Display region boundaries on minimap</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pref-showRegion" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="preference-item">
                        <div class="preference-info">
                            <div class="preference-title" data-i18n="settings.turnaround">Turn Around in Panorama</div>
                            <div class="preference-desc" data-i18n="settings.turnaround.desc">Allow rotating view 360¬∞</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pref-turnAround" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="preference-item">
                        <div class="preference-info">
                            <strong data-i18n="settings.zoom">Allow Zoom</strong>
                            <p data-i18n="settings.zoom.desc">Enable zooming in the panorama view</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pref-zoom" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="preference-item">
                        <div class="preference-info">
                            <strong data-i18n="settings.targetoriginal">Score from Original Location (Explorer Mode)</strong>
                            <p data-i18n="settings.targetoriginal.desc">ON: starting point. OFF: current position</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pref-targetOriginal" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="preference-item">
                        <div class="preference-info">
                            <strong data-i18n="settings.timetrial">‚è±Ô∏è Time Trial Mode</strong>
                            <p data-i18n="settings.timetrial.desc">Add a countdown timer to each round</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pref-timeTrial">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="preference-item" id="timeTrialSettings" style="display: none;">
                        <div class="preference-info">
                            <strong data-i18n="settings.timelimit">‚è∞ Time per Round (seconds)</strong>
                            <p data-i18n="settings.timelimit.desc">How long for each round</p>
                        </div>
                        <input type="number" id="pref-timeLimit" min="10" max="600" value="120" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                    </div>
                    
                    <div class="preference-item">
                        <div class="preference-info">
                            <strong data-i18n="settings.flashmode">‚ö° Flash Mode</strong>
                            <p data-i18n="settings.flashmode.desc">Panorama shown briefly, then hidden - test your memory!</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pref-flashMode">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="preference-item" id="flashModeSettings" style="display: none;">
                        <div class="preference-info">
                            <strong data-i18n="settings.flashduration">üëÅÔ∏è View Time (seconds)</strong>
                            <p data-i18n="settings.flashduration.desc">How long to see the panorama</p>
                        </div>
                        <input type="number" id="pref-flashDuration" min="0.1" max="10" step="0.1" value="0.5" style="width: 80px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
                    </div>
                    
                    <div class="preference-item">
                        <div class="preference-info">
                            <strong data-i18n="settings.infinite">‚ôæÔ∏è Infinite Mode</strong>
                            <p data-i18n="settings.infinite.desc">Play unlimited rounds until you decide to finish</p>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="pref-infiniteMode">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 30px;">
                    <button id="closeDifficultyModal" class="btn btn-primary" data-i18n="settings.close">Done</button>
                </div>
            </div>
        </div>

        <!-- Draw Region Modal -->
        <div id="drawRegionModal" class="modal" style="display: none;">
            <div class="modal-content modal-large">
                <h2 data-i18n="draw.title">‚úèÔ∏è Draw Your Custom Region</h2>
                <p class="modal-subtitle" data-i18n="draw.instructions">Click and drag to draw the area where you want to play</p>
                <div class="draw-mode-toggle">
                    <button id="drawModeBtn" class="mode-toggle-btn active">
                        <span>‚úèÔ∏è</span> <span data-i18n="draw.mode.draw">Draw</span>
                    </button>
                    <button id="panModeBtn" class="mode-toggle-btn">
                        <span>ü§ö</span> <span data-i18n="draw.mode.pan">Move Map</span>
                    </button>
                </div>
                <div id="drawMapContainer"></div>
                <div class="draw-save-section" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; display: none;" id="drawSaveSection">
                    <label for="customRegionName" style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;" data-i18n="draw.name">üíæ Save this region (optional):</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="customRegionName" data-i18n-placeholder="draw.name.placeholder" placeholder="Enter region name (e.g., My Hometown)" maxlength="30" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <span style="color: #666; font-size: 12px;" id="regionSlotCount">0/5 slots used</span>
                    </div>
                    <p style="margin-top: 8px; font-size: 12px; color: #666;" data-i18n="draw.savehint">Save up to 5 custom regions to reuse later</p>
                </div>
                <div class="draw-controls">
                    <button id="clearDrawing" class="btn btn-secondary" data-i18n="draw.clear">Clear Drawing</button>
                    <button id="saveDrawing" class="btn btn-success" disabled style="display: none;" data-i18n="draw.save">üíæ Save Region</button>
                    <button id="confirmDrawing" class="btn btn-primary" disabled data-i18n="draw.confirm">Use Region</button>
                    <button id="cancelDrawing" class="btn btn-secondary" data-i18n="draw.cancel">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Search Location Modal -->
        <div id="searchLocationModal" class="modal" style="display: none;">
            <div class="modal-content modal-large">
                <h2 data-i18n="search.title">üìç Search Location</h2>
                <p class="modal-subtitle" data-i18n="search.instructions">Search for a place and set the play radius</p>
                
                <div class="search-input-container" style="position: relative; margin-bottom: 20px; overflow: visible;">
                    <input type="text" id="locationSearchInput" 
                           data-i18n-placeholder="search.placeholder"
                           placeholder="Search for a city, address, or place..." 
                           autocomplete="off"
                           style="width: 100%; padding: 12px 15px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;">
                    <div id="searchResults" style="display: none; position: fixed; left: 50%; transform: translateX(-50%); width: calc(90% - 60px); max-width: 940px; background: white; border: 2px solid #667eea; border-radius: 8px; max-height: 400px; overflow-y: auto; z-index: 2000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);"></div>
                </div>
                
                <div id="searchLocationDetails" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding: 10px; background: #f0f7ff; border-radius: 8px;">
                        <span style="font-size: 24px;">üìç</span>
                        <div>
                            <div id="selectedLocationName" style="font-weight: 600; font-size: 16px;"></div>
                            <div id="selectedLocationInfo" style="font-size: 12px; color: #666;"></div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600;">
                            <span data-i18n="search.radius">Play Radius:</span>
                            <span id="radiusValue" style="color: #667eea; margin-left: 10px;">5 km</span>
                        </label>
                        <input type="range" id="radiusSlider" min="1" max="50" value="5" 
                               style="width: 100%; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666;">
                            <span>1 km</span>
                            <span>50 km</span>
                        </div>
                    </div>
                    
                    <div id="searchPreviewMap" style="width: 100%; height: 300px; border-radius: 8px; margin-bottom: 15px;"></div>
                </div>
                
                <div class="draw-controls">
                    <button id="confirmSearchLocation" class="btn btn-primary" disabled data-i18n="search.confirm">Use This Location</button>
                    <button id="cancelSearchLocation" class="btn btn-secondary" data-i18n="draw.cancel">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Final Score Modal -->
        <div id="finalScoreModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2 data-i18n="final.title">üéâ Game Complete!</h2>
                <div id="finalScoreDetails">
                    <p class="final-score"><span data-i18n="final.score">Final Score:</span> <span id="finalScore"></span></p>
                    <div id="roundBreakdown"></div>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button id="playAgain" class="btn btn-success" data-i18n="btn.start">Play Again</button>
                    <button id="returnToMenu" class="btn btn-secondary" data-i18n="btn.backmenu">Return to Menu</button>
                </div>
            </div>
        </div>

        <!-- Panorama Error Modal -->
        <div id="panoramaErrorModal" class="modal" style="display: none;">
            <div class="modal-content" style="max-width: 800px;">
                <h2 data-i18n="error.panorama.title">‚ö†Ô∏è No Panorama Found</h2>
                <p>Could not find a panorama in the selected region after <span id="attemptCount">0</span> attempts.</p>
                <div id="debugMap" style="width: 100%; height: 400px; margin: 20px 0; border-radius: 8px;"></div>
                <p style="font-size: 0.9em; color: #666;">
                    üî¥ Red dots = attempts outside polygon<br>
                    üü¢ Green dots = attempts inside polygon (but no panorama found)
                </p>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button id="retryPanorama" class="btn btn-success" data-i18n="error.panorama.retry">Retry</button>
                    <button id="cancelPanorama" class="btn btn-secondary" data-i18n="error.panorama.cancel">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Multiplayer Join/Create Modal -->
        <div id="multiplayerModal" class="modal" style="display: none;">
            <div class="modal-content">
                <h2>üë• <span data-i18n="mode.multi">Multiplayer</span></h2>
                <p class="modal-subtitle" data-i18n="mp.subtitle">Join or create a game session</p>
                
                <div class="mp-profile">
                    <h3 data-i18n="mp.profile">Your Profile</h3>
                    <div class="profile-inputs">
                        <input type="text" id="playerNick" data-i18n-placeholder="mp.nickname.placeholder" placeholder="Enter your nickname" maxlength="20" value="Player">
                        <div class="icon-selector">
                            <button class="icon-btn selected" data-icon="üòÄ">üòÄ</button>
                            <button class="icon-btn" data-icon="üòé">üòé</button>
                            <button class="icon-btn" data-icon="ü§ì">ü§ì</button>
                            <button class="icon-btn" data-icon="üòà">üòà</button>
                            <button class="icon-btn" data-icon="ü§†">ü§†</button>
                            <button class="icon-btn" data-icon="ü•≥">ü•≥</button>
                            <button class="icon-btn" data-icon="ü§ñ">ü§ñ</button>
                            <button class="icon-btn" data-icon="üëΩ">üëΩ</button>
                        </div>
                    </div>
                </div>
                
                <div class="mp-actions">
                    <div class="mp-section">
                        <h3 data-i18n="mp.create">Create New Session</h3>
                        <button id="createSessionBtn" class="btn btn-success" data-i18n="mp.createsession">Create Session</button>
                    </div>
                    
                    <div class="mp-divider" data-i18n="mp.or">OR</div>
                    
                    <div class="mp-section">
                        <h3 data-i18n="mp.join">Join Existing Session</h3>
                        <input type="text" id="sessionCodeInput" data-i18n-placeholder="mp.entercode.placeholder" placeholder="Enter session code (e.g. abc123)" maxlength="6">
                        <button id="joinSessionBtn" class="btn btn-primary" data-i18n="mp.joinsession">Join Session</button>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: center; margin-top: 20px;">
                    <button id="cancelMultiplayer" class="btn btn-secondary" data-i18n="btn.back">Back</button>
                </div>
            </div>
        </div>

        <!-- Multiplayer Lobby (shown on start screen when in multiplayer) -->
        <div id="lobbyPanel" style="display: none;">
            <div class="lobby-container">
                <div class="lobby-header">
                    <h3>üéÆ <span data-i18n="mp.lobby">Lobby</span></h3>
                    <div class="session-code">
                        <span data-i18n="mp.sessioncode">Session Code:</span>
                        <strong id="lobbySessionCode">------</strong>
                        <button id="copySessionCode" class="icon-btn" data-i18n-title="mp.copy" title="Copy">üìã</button>
                    </div>
                </div>
                
                <div class="lobby-players" id="lobbyPlayersList">
                    <!-- Players will be added dynamically -->
                </div>
                
                <div class="lobby-footer">
                    <button id="toggleReadyBtn" class="btn btn-primary" data-i18n="mp.ready">Ready</button>
                    <button id="leaveLobbyBtn" class="btn btn-secondary" data-i18n="mp.leave">Leave</button>
                </div>
            </div>
        </div>
    </div>

    <script src="i18n.js"></script>
    <script src="app.js"></script>
    <script src="multiplayer.js"></script>
</body>
</html>
